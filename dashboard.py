import streamlit as st
import pandas as pd
import requests
import xml.etree.ElementTree as ET
import altair as alt
import urllib3

# [ì„¤ì •] SSL ì¸ì¦ì„œ ê²½ê³  ë¬´ì‹œ
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ì „êµ­ ì•„íŒŒíŠ¸ ì‹¤ì‹œê°„ ì‹¤ê±°ë˜ê°€", page_icon="ğŸ“¡", layout="wide")

st.title("ğŸ“¡ ì „êµ­ ì•„íŒŒíŠ¸ ì‹¤ì‹œê°„ ì‹¤ê±°ë˜ê°€ ì¡°íšŒ")
st.markdown("êµ­í† êµí†µë¶€ APIë¥¼ ì‚¬ìš©í•˜ì—¬ **ì „êµ­ ëª¨ë“  ì§€ì—­**ì˜ ì‹¤ì‹œê°„ ë§¤ë§¤ê°€ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")

# -----------------------------------------------------------
# [ê¸°ëŠ¥ 1] ì „êµ­ í–‰ì •êµ¬ì—­ ì½”ë“œ ë°ì´í„° (ê´‘ì—­ì‹œë„ & ì‹œêµ°êµ¬)
# -----------------------------------------------------------
# ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ ì£¼ìš” ì½”ë“œë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ ë” ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
korea_regions = {
    "ì„œìš¸íŠ¹ë³„ì‹œ": {
        "ê°•ë‚¨êµ¬": "11680", "ê°•ë™êµ¬": "11740", "ê°•ë¶êµ¬": "11305", "ê°•ì„œêµ¬": "11500", "ê´€ì•…êµ¬": "11620",
        "ê´‘ì§„êµ¬": "11215", "êµ¬ë¡œêµ¬": "11530", "ê¸ˆì²œêµ¬": "11545", "ë…¸ì›êµ¬": "11350", "ë„ë´‰êµ¬": "11320",
        "ë™ëŒ€ë¬¸êµ¬": "11230", "ë™ì‘êµ¬": "11590", "ë§ˆí¬êµ¬": "11440", "ì„œëŒ€ë¬¸êµ¬": "11410", "ì„œì´ˆêµ¬": "11650",
        "ì„±ë™êµ¬": "11200", "ì„±ë¶êµ¬": "11290", "ì†¡íŒŒêµ¬": "11710", "ì–‘ì²œêµ¬": "11470", "ì˜ë“±í¬êµ¬": "11560",
        "ìš©ì‚°êµ¬": "11170", "ì€í‰êµ¬": "11380", "ì¢…ë¡œêµ¬": "11110", "ì¤‘êµ¬": "11140", "ì¤‘ë‘êµ¬": "11260"
    },
    "ë¶€ì‚°ê´‘ì—­ì‹œ": {
        "ê°•ì„œêµ¬": "26440", "ê¸ˆì •êµ¬": "26410", "ê¸°ì¥êµ°": "26710", "ë‚¨êµ¬": "26290", "ë™êµ¬": "26170",
        "ë™ë˜êµ¬": "26260", "ë¶€ì‚°ì§„êµ¬": "26230", "ë¶êµ¬": "26320", "ì‚¬ìƒêµ¬": "26530", "ì‚¬í•˜êµ¬": "26380",
        "ì„œêµ¬": "26140", "ìˆ˜ì˜êµ¬": "26500", "ì—°ì œêµ¬": "26470", "ì˜ë„êµ¬": "26200", "ì¤‘êµ¬": "26110", "í•´ìš´ëŒ€êµ¬": "26350"
    },
    "ëŒ€êµ¬ê´‘ì—­ì‹œ": {
        "êµ°ìœ„êµ°": "27720", "ë‚¨êµ¬": "27200", "ë‹¬ì„œêµ¬": "27290", "ë‹¬ì„±êµ°": "27710", "ë™êµ¬": "27140",
        "ë¶êµ¬": "27230", "ì„œêµ¬": "27170", "ìˆ˜ì„±êµ¬": "27260", "ì¤‘êµ¬": "27110"
    },
    "ì¸ì²œê´‘ì—­ì‹œ": {
        "ê°•í™”êµ°": "28710", "ê³„ì–‘êµ¬": "28245", "ë‚¨ë™êµ¬": "28200", "ë™êµ¬": "28140", "ë¯¸ì¶”í™€êµ¬": "28177",
        "ë¶€í‰êµ¬": "28237", "ì„œêµ¬": "28260", "ì—°ìˆ˜êµ¬": "28185", "ì˜¹ì§„êµ°": "28720", "ì¤‘êµ¬": "28110"
    },
    "ê´‘ì£¼ê´‘ì—­ì‹œ": {
        "ê´‘ì‚°êµ¬": "29200", "ë‚¨êµ¬": "29155", "ë™êµ¬": "29110", "ë¶êµ¬": "29170", "ì„œêµ¬": "29140"
    },
    "ëŒ€ì „ê´‘ì—­ì‹œ": {
        "ëŒ€ë•êµ¬": "30230", "ë™êµ¬": "30110", "ì„œêµ¬": "30170", "ìœ ì„±êµ¬": "30200", "ì¤‘êµ¬": "30140"
    },
    "ìš¸ì‚°ê´‘ì—­ì‹œ": {
        "ë‚¨êµ¬": "31140", "ë™êµ¬": "31170", "ë¶êµ¬": "31200", "ìš¸ì£¼êµ°": "31710", "ì¤‘êµ¬": "31110"
    },
    "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ": {
        "ì„¸ì¢…ì‹œ": "36110"
    },
    "ê²½ê¸°ë„": {
        "ê°€í‰êµ°": "41820", "ê³ ì–‘ì‹œ ë•ì–‘êµ¬": "41281", "ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬": "41285", "ê³ ì–‘ì‹œ ì¼ì‚°ì„œêµ¬": "41287",
        "ê³¼ì²œì‹œ": "41290", "ê´‘ëª…ì‹œ": "41210", "ê´‘ì£¼ì‹œ": "41610", "êµ¬ë¦¬ì‹œ": "41310", "êµ°í¬ì‹œ": "41410",
        "ê¹€í¬ì‹œ": "41570", "ë‚¨ì–‘ì£¼ì‹œ": "41360", "ë™ë‘ì²œì‹œ": "41250", "ë¶€ì²œì‹œ": "41190", "ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬": "41135",
        "ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬": "41131", "ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬": "41133", "ìˆ˜ì›ì‹œ ê¶Œì„ êµ¬": "41113", "ìˆ˜ì›ì‹œ ì˜í†µêµ¬": "41117",
        "ìˆ˜ì›ì‹œ ì¥ì•ˆêµ¬": "41111", "ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬": "41115", "ì‹œí¥ì‹œ": "41390", "ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬": "41273",
        "ì•ˆì‚°ì‹œ ìƒë¡êµ¬": "41271", "ì•ˆì„±ì‹œ": "41550", "ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬": "41173", "ì•ˆì–‘ì‹œ ë§Œì•ˆêµ¬": "41171",
        "ì–‘ì£¼ì‹œ": "41630", "ì–‘í‰êµ°": "41830", "ì—¬ì£¼ì‹œ": "41670", "ì—°ì²œêµ°": "41800", "ì˜¤ì‚°ì‹œ": "41370",
        "ìš©ì¸ì‹œ ê¸°í¥êµ¬": "41463", "ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬": "41465", "ìš©ì¸ì‹œ ì²˜ì¸êµ¬": "41461", "ì˜ì™•ì‹œ": "41430",
        "ì˜ì •ë¶€ì‹œ": "41150", "ì´ì²œì‹œ": "41500", "íŒŒì£¼ì‹œ": "41480", "í‰íƒì‹œ": "41220", "í¬ì²œì‹œ": "41650",
        "í•˜ë‚¨ì‹œ": "41450", "í™”ì„±ì‹œ": "41590"
    },
    "ê°•ì›íŠ¹ë³„ìì¹˜ë„": {
        "ê°•ë¦‰ì‹œ": "42150", "ê³ ì„±êµ°": "42820", "ë™í•´ì‹œ": "42170", "ì‚¼ì²™ì‹œ": "42230", "ì†ì´ˆì‹œ": "42210",
        "ì–‘êµ¬êµ°": "42800", "ì–‘ì–‘êµ°": "42830", "ì˜ì›”êµ°": "42750", "ì›ì£¼ì‹œ": "42130", "ì¸ì œêµ°": "42810",
        "ì •ì„ êµ°": "42770", "ì² ì›êµ°": "42780", "ì¶˜ì²œì‹œ": "42110", "íƒœë°±ì‹œ": "42190", "í‰ì°½êµ°": "42760",
        "í™ì²œêµ°": "42720", "í™”ì²œêµ°": "42790", "íš¡ì„±êµ°": "42730"
    },
    "ì¶©ì²­ë¶ë„": {
        "ê´´ì‚°êµ°": "43760", "ë‹¨ì–‘êµ°": "43800", "ë³´ì€êµ°": "43720", "ì˜ë™êµ°": "43740", "ì˜¥ì²œêµ°": "43730",
        "ìŒì„±êµ°": "43770", "ì œì²œì‹œ": "43150", "ì¦í‰êµ°": "43745", "ì§„ì²œêµ°": "43750", "ì²­ì£¼ì‹œ ìƒë‹¹êµ¬": "43111",
        "ì²­ì£¼ì‹œ ì„œì›êµ¬": "43112", "ì²­ì£¼ì‹œ ì²­ì›êµ¬": "43114", "ì²­ì£¼ì‹œ í¥ë•êµ¬": "43113", "ì¶©ì£¼ì‹œ": "43130"
    },
    "ì¶©ì²­ë‚¨ë„": {
        "ê³„ë£¡ì‹œ": "44250", "ê³µì£¼ì‹œ": "44150", "ê¸ˆì‚°êµ°": "44710", "ë…¼ì‚°ì‹œ": "44230", "ë‹¹ì§„ì‹œ": "44270",
        "ë³´ë ¹ì‹œ": "44180", "ë¶€ì—¬êµ°": "44760", "ì„œì‚°ì‹œ": "44210", "ì„œì²œêµ°": "44770", "ì•„ì‚°ì‹œ": "44200",
        "ì˜ˆì‚°êµ°": "44810", "ì²œì•ˆì‹œ ë™ë‚¨êµ¬": "44131", "ì²œì•ˆì‹œ ì„œë¶êµ¬": "44133", "ì²­ì–‘êµ°": "44790", "íƒœì•ˆêµ°": "44825",
        "í™ì„±êµ°": "44800"
    },
    "ì „ë¶íŠ¹ë³„ìì¹˜ë„": {
        "ê³ ì°½êµ°": "45790", "êµ°ì‚°ì‹œ": "45130", "ê¹€ì œì‹œ": "45210", "ë‚¨ì›ì‹œ": "45190", "ë¬´ì£¼êµ°": "45730",
        "ë¶€ì•ˆêµ°": "45800", "ìˆœì°½êµ°": "45770", "ì™„ì£¼êµ°": "45710", "ìµì‚°ì‹œ": "45140", "ì„ì‹¤êµ°": "45750",
        "ì¥ìˆ˜êµ°": "45740", "ì „ì£¼ì‹œ ë•ì§„êµ¬": "45113", "ì „ì£¼ì‹œ ì™„ì‚°êµ¬": "45111", "ì •ìì‹œ": "45180", "ì§„ì•ˆêµ°": "45720"
    },
    "ì „ë¼ë‚¨ë„": {
        "ê°•ì§„êµ°": "46810", "ê³ í¥êµ°": "46770", "ê³¡ì„±êµ°": "46720", "ê´‘ì–‘ì‹œ": "46230", "êµ¬ë¡€êµ°": "46730",
        "ë‚˜ì£¼ì‹œ": "46170", "ë‹´ì–‘êµ°": "46710", "ëª©í¬ì‹œ": "46110", "ë¬´ì•ˆêµ°": "46840", "ë³´ì„±êµ°": "46780",
        "ìˆœì²œì‹œ": "46150", "ì‹ ì•ˆêµ°": "46910", "ì—¬ìˆ˜ì‹œ": "46130", "ì˜ê´‘êµ°": "46870", "ì˜ì•”êµ°": "46830",
        "ì™„ë„êµ°": "46890", "ì¥ì„±êµ°": "46880", "ì¥í¥êµ°": "46800", "ì§„ë„êµ°": "46900", "í•¨í‰êµ°": "46860",
        "í•´ë‚¨êµ°": "46820", "í™”ìˆœêµ°": "46790"
    },
    "ê²½ìƒë¶ë„": {
        "ê²½ì‚°ì‹œ": "47290", "ê²½ì£¼ì‹œ": "47130", "ê³ ë ¹êµ°": "47830", "êµ¬ë¯¸ì‹œ": "47190", "ê¹€ì²œì‹œ": "47150",
        "ë¬¸ê²½ì‹œ": "47280", "ë´‰í™”êµ°": "47920", "ìƒì£¼ì‹œ": "47250", "ì„±ì£¼êµ°": "47840", "ì•ˆë™ì‹œ": "47170",
        "ì˜ë•êµ°": "47770", "ì˜ì–‘êµ°": "47760", "ì˜ì£¼ì‹œ": "47210", "ì˜ì²œì‹œ": "47230", "ì˜ˆì²œêµ°": "47900",
        "ìš¸ë¦‰êµ°": "47940", "ìš¸ì§„êµ°": "47930", "ì˜ì„±êµ°": "47730", "ì²­ë„êµ°": "47820", "ì²­ì†¡êµ°": "47750",
        "ì¹ ê³¡êµ°": "47850", "í¬í•­ì‹œ ë‚¨êµ¬": "47111", "í¬í•­ì‹œ ë¶êµ¬": "47113"
    },
    "ê²½ìƒë‚¨ë„": {
        "ê±°ì œì‹œ": "48310", "ê±°ì°½êµ°": "48880", "ê³ ì„±êµ°": "48820", "ê¹€í•´ì‹œ": "48250", "ë‚¨í•´êµ°": "48840",
        "ë°€ì–‘ì‹œ": "48270", "ì‚¬ì²œì‹œ": "48240", "ì‚°ì²­êµ°": "48860", "ì–‘ì‚°ì‹œ": "48330", "ì˜ë ¹êµ°": "48720",
        "ì§„ì£¼ì‹œ": "48170", "ì°½ë…•êµ°": "48740", "ì°½ì›ì‹œ ë§ˆì‚°í•©í¬êµ¬": "48125", "ì°½ì›ì‹œ ë§ˆì‚°íšŒì›êµ¬": "48127",
        "ì°½ì›ì‹œ ì„±ì‚°êµ¬": "48123", "ì°½ì›ì‹œ ì˜ì°½êµ¬": "48121", "ì°½ì›ì‹œ ì§„í•´êµ¬": "48129", "í†µì˜ì‹œ": "48220",
        "í•˜ë™êµ°": "48850", "í•¨ì•ˆêµ°": "48730", "í•¨ì–‘êµ°": "48870", "í•©ì²œêµ°": "48890"
    },
    "ì œì£¼íŠ¹ë³„ìì¹˜ë„": {
        "ì„œê·€í¬ì‹œ": "50130", "ì œì£¼ì‹œ": "50110"
    }
}

# -----------------------------------------------------------
# [ê¸°ëŠ¥ 2] ì‚¬ì´ë“œë°” ì„¤ì • (í‚¤ ì €ì¥ & ê³„ë‹¨ì‹ ì„ íƒ)
# -----------------------------------------------------------
st.sidebar.header("ğŸ”‘ ì„¤ì • ë° ì¡°íšŒ")

# (1) API í‚¤ ìë™ ì €ì¥
if 'saved_api_key' not in st.session_state:
    st.session_state['saved_api_key'] = ''

api_key_input = st.sidebar.text_input(
    "ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ (Decoding Key)", 
    type="password", 
    value=st.session_state['saved_api_key'],
    help="í•œë²ˆ ì…ë ¥í•˜ë©´ ìœ ì§€ë©ë‹ˆë‹¤."
)
if api_key_input:
    st.session_state['saved_api_key'] = api_key_input

st.sidebar.markdown("---")

# (2) 1ë‹¨ê³„: ì‹œ/ë„ ì„ íƒ
si_do_list = list(korea_regions.keys())
selected_si_do = st.sidebar.selectbox("1. ì‹œ/ë„ ì„ íƒ", si_do_list)

# (3) 2ë‹¨ê³„: êµ¬/êµ° ì„ íƒ (ì„ íƒëœ ì‹œ/ë„ì— ë”°ë¼ ë°”ë€œ)
gu_gun_dict = korea_regions[selected_si_do]
gu_gun_list = list(gu_gun_dict.keys())
selected_gu_gun = st.sidebar.selectbox("2. êµ¬/êµ° ì„ íƒ", gu_gun_list)

# (4) ë‚ ì§œ ì„ íƒ
c1, c2 = st.sidebar.columns(2)
year = c1.selectbox("ë…„ë„", ["2025", "2024", "2023"], index=1)
month = c2.selectbox("ì›”", [f"{i:02d}" for i in range(1, 13)], index=11)
deal_ymd = year + month

lawd_cd = gu_gun_dict[selected_gu_gun]

# -----------------------------------------------------------
# [ê¸°ëŠ¥ 3] ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë°©í™”ë²½ ìš°íšŒ & í†µì—­)
# -----------------------------------------------------------
@st.cache_data
def fetch_data(api_key, lawd_cd, deal_ymd):
    url = "https://apis.data.go.kr/1613000/RTMSDataSvcAptTrade/getRTMSDataSvcAptTrade"
    params = {
        "serviceKey": api_key, "LAWD_CD": lawd_cd, "DEAL_YMD": deal_ymd,
        "numOfRows": "2000", "pageNo": "1" # ë°ì´í„° ë„‰ë„‰í•˜ê²Œ 2000ê°œ ìš”ì²­
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    }
    
    try:
        response = requests.get(url, params=params, headers=headers, verify=False, timeout=15)
        try:
            root = ET.fromstring(response.content)
        except ET.ParseError:
            return f"ğŸš¨ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (XML ì•„ë‹˜): {response.text}"
        
        header_code = root.find('.//resultCode')
        if header_code is not None:
            code_val = header_code.text.strip()
            if code_val not in ['00', '000']:
                return f"API Error: {root.find('.//resultMsg').text} (ì½”ë“œ: {code_val})"

        items = root.findall('.//item')
        if not items:
            return None
        
        data = []
        for item in items:
            row = {}
            for child in item:
                if child.text:
                    row[child.tag] = child.text.strip()
            data.append(row)
        return pd.DataFrame(data)
    except Exception as e:
        return f"í†µì‹  ì˜¤ë¥˜ ë°œìƒ: {e}"

# -----------------------------------------------------------
# [ê¸°ëŠ¥ 4] ë©”ì¸ ë¡œì§ (ì¡°íšŒ ë²„íŠ¼ ë° ê²°ê³¼ ì²˜ë¦¬)
# -----------------------------------------------------------
if st.sidebar.button("ğŸš€ ë°ì´í„° ì¡°íšŒí•˜ê¸° (3ë‹¨ê³„ ë™/ë©´ ì„ íƒ)"):
    st.session_state['search_clicked'] = True
    st.session_state['search_params'] = (lawd_cd, deal_ymd, selected_si_do, selected_gu_gun)

# ì¡°íšŒ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í™”ë©´ í‘œì‹œ
if st.session_state.get('search_clicked'):
    current_lawd, current_ymd, si_name, gu_name = st.session_state['search_params']
    
    if not st.session_state['saved_api_key']:
        st.error("âš ï¸ ì‚¬ì´ë“œë°”ì— ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        with st.spinner(f"{si_name} {gu_name} ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."):
            result = fetch_data(st.session_state['saved_api_key'], current_lawd, current_ymd)
            
            if isinstance(result, str):
                st.error("âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                st.code(result)
            elif result is None or result.empty:
                st.info("í•´ë‹¹ ì§€ì—­/ê¸°ê°„ì— ì‹ ê³ ëœ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                df = result.copy()
                
                # ì»¬ëŸ¼ ë§¤í•‘
                col_map = {
                    'aptNm': 'ì•„íŒŒíŠ¸', 'ë‹¨ì§€ëª…': 'ì•„íŒŒíŠ¸',
                    'dealAmount': 'ê±°ë˜ê¸ˆì•¡', 'amount': 'ê±°ë˜ê¸ˆì•¡',
                    'excluUseAr': 'ì „ìš©ë©´ì ', 'area': 'ì „ìš©ë©´ì ', 
                    'umdNm': 'ë²•ì •ë™', 'dong': 'ë²•ì •ë™',
                    'floor': 'ì¸µ', 'dealDay': 'ì¼', 'day': 'ì¼'
                }
                df = df.rename(columns=col_map)
                
                # í•„ìˆ˜ ì»¬ëŸ¼ ì±„ìš°ê¸°
                for col in ['ì•„íŒŒíŠ¸', 'ê±°ë˜ê¸ˆì•¡', 'ì „ìš©ë©´ì ', 'ë²•ì •ë™', 'ì¸µ', 'ì¼']:
                    if col not in df.columns:
                        df[col] = "-" if col != 'ê±°ë˜ê¸ˆì•¡' else "0"

                # ìˆ«ì ë³€í™˜
                df['ê±°ë˜ê¸ˆì•¡_ìˆ«ì'] = df['ê±°ë˜ê¸ˆì•¡'].astype(str).str.replace(',', '').astype(int)
                df['ì „ìš©ë©´ì _ìˆ«ì'] = pd.to_numeric(df['ì „ìš©ë©´ì '], errors='coerce').fillna(0)
                df['ê³„ì•½ì¼'] = current_ymd + df['ì¼'].astype(str).str.zfill(2)
                df['í‰ìˆ˜'] = df['ì „ìš©ë©´ì _ìˆ«ì'] / 3.3058

                # -----------------------------------------------------------
                # [ê¸°ëŠ¥ 5] 3ë‹¨ê³„: ë™/ë©´ ì„ íƒ (ë°ì´í„° ê¸°ë°˜ í•„í„°ë§)
                # -----------------------------------------------------------
                st.sidebar.markdown("---")
                st.sidebar.subheader("ğŸ“ 3. ìƒì„¸ ì§€ì—­ (ë™/ë©´) ì„ íƒ")
                
                # ë°ì´í„°ì— ìˆëŠ” ì‹¤ì œ ë²•ì •ë™ë§Œ ì¶”ì¶œí•˜ì—¬ ëª©ë¡ ìƒì„±
                if 'ë²•ì •ë™' in df.columns:
                    dong_list = sorted(df['ë²•ì •ë™'].unique())
                    dong_list.insert(0, "ì „ì²´ ë³´ê¸°")
                    
                    selected_dong = st.sidebar.selectbox("ë™/ë©´ì„ ì„ íƒí•˜ì„¸ìš”", dong_list)
                    
                    # í•„í„°ë§
                    if selected_dong != "ì „ì²´ ë³´ê¸°":
                        df = df[df['ë²•ì •ë™'] == selected_dong]
                        st.info(f"ğŸ“ {si_name} {gu_name} **{selected_dong}** ë‚´ì—­ì„ í‘œì‹œí•©ë‹ˆë‹¤.")
                    else:
                        st.success(f"âœ… {si_name} {gu_name} **ì „ì²´** ë‚´ì—­ì„ í‘œì‹œí•©ë‹ˆë‹¤.")
                
                # -----------------------------------------------------------
                # [ê¸°ëŠ¥ 6] ê²°ê³¼ ì‹œê°í™”
                # -----------------------------------------------------------
                if not df.empty:
                    # ìš”ì•½
                    c1, c2, c3 = st.columns(3)
                    avg_p = df['ê±°ë˜ê¸ˆì•¡_ìˆ«ì'].mean()
                    max_p = df['ê±°ë˜ê¸ˆì•¡_ìˆ«ì'].max()
                    c1.metric("í‰ê·  ê±°ë˜ê°€", f"{avg_p/10000:.1f}ì–µì›")
                    c2.metric("ìµœê³  ê±°ë˜ê°€", f"{max_p/10000:.1f}ì–µì›")
                    top_apt = df['ì•„íŒŒíŠ¸'].mode()[0] if not df['ì•„íŒŒíŠ¸'].mode().empty else "-"
                    c3.metric("ìµœë‹¤ ê±°ë˜ ì•„íŒŒíŠ¸", top_apt)
                    
                    st.divider()
                    
                    # ì°¨íŠ¸
                    st.subheader(f"ğŸ“Š {selected_dong if 'selected_dong' in locals() and selected_dong != 'ì „ì²´ ë³´ê¸°' else gu_name} ê±°ë˜ íë¦„")
                    chart = alt.Chart(df).mark_circle(size=80).encode(
                        x=alt.X('ê³„ì•½ì¼', title='ë‚ ì§œ'),
                        y=alt.Y('ê±°ë˜ê¸ˆì•¡_ìˆ«ì', title='ê±°ë˜ê¸ˆì•¡(ë§Œì›)', scale=alt.Scale(zero=False)),
                        color=alt.Color('ë²•ì •ë™', title='ë²•ì •ë™', legend=None),
                        tooltip=['ê³„ì•½ì¼', 'ë²•ì •ë™', 'ì•„íŒŒíŠ¸', 'ì „ìš©ë©´ì ', 'ê±°ë˜ê¸ˆì•¡', 'ì¸µ']
                    ).interactive()
                    st.altair_chart(chart, use_container_width=True)
                    
                    # í‘œ
                    st.subheader("ğŸ“‹ ìƒì„¸ ê±°ë˜ ë‚´ì—­")
                    cols = ['ê³„ì•½ì¼', 'ë²•ì •ë™', 'ì•„íŒŒíŠ¸', 'ì „ìš©ë©´ì ', 'ê±°ë˜ê¸ˆì•¡', 'ì¸µ']
                    st.dataframe(
                        df[cols].sort_values('ê³„ì•½ì¼', ascending=False), 
                        use_container_width=True
                    )
                else:
                    st.warning("ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

else:
    st.info("ğŸ‘ˆ ì‚¬ì´ë“œë°”ì—ì„œ ì‹œ/ë„ì™€ êµ¬/êµ°ì„ ì„ íƒí•˜ê³  [ì¡°íšŒí•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
